-- Create the SKU_ATTRIBUTE table
CREATE TABLE SKU_ATTRIBUTE (
                               SKU_ATTRIBUTE_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
                               GROUP_ID NUMBER,
                               SKU_ID NUMBER NOT NULL,
                               ATTRIBUTE_ID NUMBER NOT NULL,
                               ATTRIBUTE_VALUE VARCHAR2(450) NOT NULL,
                               CONSTRAINT FK_SKU_ATTRIBUTE_SKUS FOREIGN KEY (SKU_ID) REFERENCES SKU(SKU_ID),
                               CONSTRAINT FK_SKU_ATTRIBUTE_ATTRIBUTES FOREIGN KEY (ATTRIBUTE_ID) REFERENCES ATTRIBUTE(ATTRIBUTE_ID)
);

-- Create sequence for GROUP_ID
CREATE SEQUENCE group_id_seq START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;

-- Create trigger to auto-generate GROUP_ID
CREATE OR REPLACE TRIGGER trg_group_id_before_insert
BEFORE INSERT ON SKU_ATTRIBUTE
FOR EACH ROW
BEGIN
   IF :NEW.GROUP_ID IS NULL THEN
      :NEW.GROUP_ID := group_id_seq.NEXTVAL;
END IF;
END;
/

-- Merge (upsert) SKU_ATTRIBUTE data to avoid duplicates

MERGE INTO SKU_ATTRIBUTE sa
USING (SELECT 1 AS SKU_ID, 1 AS ATTRIBUTE_ID, '20' AS ATTRIBUTE_VALUE FROM dual) src
ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
WHEN NOT MATCHED THEN
  INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
  VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 1 AS SKU_ID, 2 AS ATTRIBUTE_ID, '6.1' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 1 AS SKU_ID, 9 AS ATTRIBUTE_ID, 'Graphite' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 1 AS SKU_ID, 15 AS ATTRIBUTE_ID, 'iOS 17' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

-- Another SKU example (sku_id = 3)
MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 3 AS SKU_ID, 1 AS ATTRIBUTE_ID, '25' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 3 AS SKU_ID, 2 AS ATTRIBUTE_ID, '6.8' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 3 AS SKU_ID, 9 AS ATTRIBUTE_ID, 'Phantom Black' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);

MERGE INTO SKU_ATTRIBUTE sa
    USING (SELECT 3 AS SKU_ID, 15 AS ATTRIBUTE_ID, 'Android 14' AS ATTRIBUTE_VALUE FROM dual) src
    ON (sa.SKU_ID = src.SKU_ID AND sa.ATTRIBUTE_ID = src.ATTRIBUTE_ID AND sa.ATTRIBUTE_VALUE = src.ATTRIBUTE_VALUE)
    WHEN NOT MATCHED THEN
        INSERT (SKU_ID, ATTRIBUTE_ID, ATTRIBUTE_VALUE)
            VALUES (src.SKU_ID, src.ATTRIBUTE_ID, src.ATTRIBUTE_VALUE);
